#!/sbin/openrc-run
  
name=$RC_SVCNAME
#command=""
#command_args=""
#command_user="root"
pidfile="/run/$RC_SVCNAME/$RC_SVCNAME.pid"
start_stop_daemon_args=""
command_background="no"

depend() {
        need root localmount
}

start_pre() {
        # Not needed for oneshot Service
        # checkpath --directory --owner $command_user:$command_user --mode 0755 /run/$RC_SVCNAME

        checkpath --directory --owner $command_user:$command_user --mode 0755 /run
        checkpath --directory --owner $command_user:$command_user --mode 0755 /run/user
}

start() {
        # Create Folder if not exist
        mkdir -p /run/user
        chmod 0755 /run/user

        # Create Folder for User (Manual Way)
        checkpath --directory --owner podman:podman --mode 0700 /run/user/$(id -u podman)

        # Do it for every User (automatically)
        while IFS='' read -r user_line || [ -n "${user_line}" ]; do
            eindent 1
            einfo "Processing User: ${user_line}"

            # Get User Name
            user_name=`echo "${user_line}" | cut -d: -f1`

            # Get User ID
            user_id=`echo "${user_line}" | cut -d: -f2`

            eindent 2
            einfo "Creating Folder /run/user/${user_id} for User ${user_name}"
            checkpath --directory --owner ${user_name}:${user_name} --mode 0700 /run/user/${user_id}
        done < <( awk -F: '{printf "%s:%s\n",$1,$3}' /etc/passwd | sort -t ":" --key=2 --numeric | grep -E "^[a-z]+:[0-9]{4}$" )
}
